# 注意：修改为使用 CRI Docker 而非 Containerd
# 将容器运行时 socket 从 containerd 改为 cri-docker
# - 之前的路径: /run/containerd/containerd.sock
# - 当前路径: /var/run/cri-dockerd.sock (CRI Docker socket)
# - 备选路径: /var/run/docker.sock (Docker socket)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: health-check-deployment
spec:
  selector:
    matchLabels:
      app: health-check
  template:
    metadata:
      labels:
        app: health-check
    spec:
      # nodeSelector:
      #   kubernetes.io/hostname: k8s-node01
      containers:
        - name: health-check
          image: madhuakula/k8s-goat-health-check
          imagePullPolicy: IfNotPresent
          resources:
            limits:
              memory: "100Mi"
              cpu: "30m"
          ports:
            - containerPort: 80
          # 自定义配置 - 挂载 CRI Docker socket 用于 DIND (Docker-in-Docker)
          # 已修改: 从 containerd socket 改为 cri-docker socket
          securityContext:
            privileged: true
          volumeMounts:
            # 挂载 CRI Docker socket 而不是 containerd
            - mountPath: /var/run/cri-dockerd.sock
              name: docker-sock-volume
      volumes:
        # 已修改: 从 containerd socket (/run/containerd/containerd.sock)
        # 改为 CRI Docker socket (/var/run/cri-dockerd.sock)
        - name: docker-sock-volume
          hostPath:
            path: /var/run/cri-dockerd.sock
            type: Socket
---
apiVersion: v1
kind: Service
metadata:
  name: health-check-service
spec:
  type: NodePort
  ports:
    - protocol: TCP
      port: 80
      targetPort: 80
      nodePort: 30001
  selector:
    app: health-check
